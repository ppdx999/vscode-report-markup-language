<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RML PDF Preview</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: var(--vscode-editor-background);
            color: var(--vscode-editor-foreground);
            font-family: var(--vscode-font-family);
            overflow: hidden;
        }
        
        .header {
            padding: 10px;
            background-color: var(--vscode-panel-background);
            border-bottom: 1px solid var(--vscode-panel-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-weight: bold;
            color: var(--vscode-foreground);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .zoom-level {
            font-size: 12px;
            min-width: 40px;
            text-align: center;
        }
        
        .pdf-container {
            height: calc(100vh - 50px);
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        
        .pdf-page {
            margin: 10px auto;
            border: 1px solid var(--vscode-panel-border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            background: white;
        }
        
        .error {
            color: var(--vscode-errorForeground);
            text-align: center;
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--vscode-foreground);
        }
        
        .page-info {
            padding: 5px;
            font-size: 12px;
            color: var(--vscode-descriptionForeground);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">RML PDF Preview</div>
        <div class="controls">
            <div class="zoom-controls">
                <button onclick="zoomOut()">-</button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button onclick="zoomIn()">+</button>
            </div>
            <button onclick="prevPage()">← Prev</button>
            <span class="page-info" id="pageInfo">Page 1 of 1</span>
            <button onclick="nextPage()">Next →</button>
            <button onclick="openExternal()">Open External</button>
        </div>
    </div>
    
    <div class="pdf-container" id="pdfContainer">
        <div class="loading">Loading PDF...</div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let pdfDoc = null;
        let currentPage = 1;
        let currentZoom = 1.0;
        let currentPdfPath = '';
        
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.type) {
                case 'loadPdf':
                    loadPdf(message.pdfData, message.fileName);
                    break;
            }
        });
        
        async function loadPdf(pdfData, fileName) {
            currentPdfPath = fileName;
            document.querySelector('.title').textContent = `RML PDF Preview - ${fileName}`;
            
            const container = document.getElementById('pdfContainer');
            container.innerHTML = '<div class="loading">Loading PDF...</div>';
            
            try {
                // Convert base64 to Uint8Array
                const binaryString = atob(pdfData);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                pdfDoc = await pdfjsLib.getDocument(bytes).promise;
                currentPage = 1;
                await renderAllPages();
                updatePageInfo();
            } catch (error) {
                console.error('Error loading PDF:', error);
                container.innerHTML = '<div class="error">Failed to load PDF: ' + error.message + '</div>';
            }
        }
        
        async function renderAllPages() {
            const container = document.getElementById('pdfContainer');
            container.innerHTML = '';
            
            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                try {
                    const page = await pdfDoc.getPage(pageNum);
                    const scale = currentZoom;
                    const viewport = page.getViewport({ scale });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.className = 'pdf-page';
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    await page.render(renderContext).promise;
                    container.appendChild(canvas);
                } catch (error) {
                    console.error(`Error rendering page ${pageNum}:`, error);
                }
            }
        }
        
        function updatePageInfo() {
            if (pdfDoc) {
                document.getElementById('pageInfo').textContent = `${pdfDoc.numPages} pages`;
                document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
            }
        }
        
        async function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.25, 3.0);
            if (pdfDoc) {
                await renderAllPages();
                updatePageInfo();
            }
        }
        
        async function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.25, 0.25);
            if (pdfDoc) {
                await renderAllPages();
                updatePageInfo();
            }
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                scrollToPage(currentPage);
            }
        }
        
        function nextPage() {
            if (pdfDoc && currentPage < pdfDoc.numPages) {
                currentPage++;
                scrollToPage(currentPage);
            }
        }
        
        function scrollToPage(pageNum) {
            const pages = document.querySelectorAll('.pdf-page');
            if (pages[pageNum - 1]) {
                pages[pageNum - 1].scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function openExternal() {
            vscode.postMessage({
                type: 'openExternal',
                pdfPath: currentPdfPath
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            vscode.postMessage({
                type: 'ready'
            });
        });
    </script>
</body>
</html>